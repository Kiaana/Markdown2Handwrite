<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown to Handwriting</title>
    <link href="./tailwind.css" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'handwriting-font';
            src: url('handwriting-font.ttf') format('truetype');
        }
        .lined-paper {
            background: repeating-linear-gradient(
                to bottom,
                rgba(245, 245, 220, 0.8),
                rgba(245, 245, 220, 0.8) 23px,
                rgba(204, 204, 204, 0.8) 24px
            );
            padding: 20px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            font-family: 'handwriting-font', cursive;
            font-size: 24px;
            line-height: 24px;
            white-space: normal;
            text-align: left;
            backdrop-filter: blur(10px);
        }
        .katex, .katex .katex-mathml, .katex .katex-html, .katex .katex-mathml * {
            font-family: 'handwriting-font', cursive !important;
            font-size: 24px !important;
            line-height: 24px !important;
        }
    </style>
    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
</head>
<body class="bg-gradient-to-r from-blue-400 to-purple-500 min-h-screen flex items-center justify-center p-6">
    <div id="container" class="bg-white bg-opacity-30 backdrop-blur-lg shadow-lg rounded-lg p-8 max-w-2xl w-full text-center"> 
        <h1 class="text-4xl font-bold mb-6 text-white">Markdown to Handwriting</h1>
        <textarea id="markdown-input" class="w-full h-48 p-4 mb-6 text-lg rounded-lg shadow-inner resize-none" placeholder="Enter Markdown text here..."></textarea>
        <div id="rendered-output" class="lined-paper mb-6 hidden"></div>
        <button id="render-button" class="bg-blue-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-600 transition">Render Handwriting</button>
        <button id="download-button" class="bg-green-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-600 transition mt-4">Download as Image</button>
        <canvas id="canvas" class="hidden"></canvas>
    </div>

    <!-- Marked.js and KaTeX Script -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
    
    <script>
        function renderMarkdownWithMath(markdown) {
            // Render Markdown
            let html = marked.parse(markdown);

            // Render KaTeX
            html = html.replace(/\$\$([^$]+)\$\$/g, (match, p1) => {
                return katex.renderToString(p1, { displayMode: true });
            });

            html = html.replace(/\$([^$]+)\$/g, (match, p1) => {
                return katex.renderToString(p1, { displayMode: false });
            });

            return html;
        }

        document.getElementById('render-button').addEventListener('click', () => {
            const markdownInput = document.getElementById('markdown-input').value;
            const renderedOutput = document.getElementById('rendered-output');
            renderedOutput.innerHTML = renderMarkdownWithMath(markdownInput);
            renderedOutput.classList.remove('hidden');
        });

        document.getElementById('download-button').addEventListener('click', () => {
            const renderedOutput = document.getElementById('rendered-output');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            const width = renderedOutput.offsetWidth;
            const height = renderedOutput.offsetHeight;
            canvas.width = width;
            canvas.height = height;

            // Draw the lined paper background
            ctx.fillStyle = 'rgba(245, 245, 220, 0.8)';
            ctx.fillRect(0, 0, width, height);

            ctx.strokeStyle = 'rgba(204, 204, 204, 0.8)';
            for (let y = 24; y < height; y += 24) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }

            // Convert the rendered output to SVG and draw it onto the canvas
            const data = new XMLSerializer().serializeToString(renderedOutput);
            const svg = `
                <svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}">
                    <foreignObject width="100%" height="100%">
                        <div xmlns="http://www.w3.org/1999/xhtml" style="font-family: handwriting-font; font-size: 24px; line-height: 24px;">
                            ${data}
                        </div>
                    </foreignObject>
                </svg>`;
            const svgBlob = new Blob([svg], { type: "image/svg+xml;charset=utf-8" });
            const url = URL.createObjectURL(svgBlob);

            const img = new Image();
            img.crossOrigin = 'anonymous'; // This is crucial for avoiding CORS issues
            img.onload = () => {
                ctx.drawImage(img, 0, 0);
                URL.revokeObjectURL(url);

                // Create a download link
                const link = document.createElement('a');
                link.download = 'handwritten.png';
                link.href = canvas.toDataURL();
                link.click();
            };
            img.src = url;
        });
    </script>
</body>
</html>
